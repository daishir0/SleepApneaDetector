<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç„¡å‘¼å¸æ¤œå‡ºãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š - Sleep Apnea Calibration</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .upload-section {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .upload-section input[type="file"] {
            margin: 10px 0;
        }

        .upload-section button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }

        .upload-section button:hover {
            background: #2980b9;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .controls label {
            font-size: 14px;
            color: #555;
            margin-right: 5px;
        }

        .controls input[type="range"] {
            width: 200px;
        }

        .controls input[type="number"] {
            width: 80px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .controls button {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .controls button:hover {
            background: #229954;
        }

        .controls button.danger {
            background: #e74c3c;
        }

        .controls button.danger:hover {
            background: #c0392b;
        }

        .waveform-container {
            margin: 20px 0;
            background: white;
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 20px;
        }

        .info-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-card {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
        }

        .info-card h3 {
            color: #2c3e50;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .info-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }

        .markers-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .markers-list h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .marker-item {
            background: white;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #e74c3c;
        }

        .marker-item button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .status {
            margin: 15px 0;
            padding: 12px;
            border-radius: 5px;
            display: none;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .audio-controls {
            display: none;
            background: #34495e;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .audio-controls audio {
            width: 100%;
        }

        .instruction {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .instruction h3 {
            margin-bottom: 10px;
        }

        .instruction ol {
            margin-left: 20px;
        }

        .instruction li {
            margin-bottom: 5px;
        }

        .files-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .files-section h2 {
            color: #2c3e50;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .files-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .file-item {
            background: white;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #3498db;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: bold;
            color: #2c3e50;
            cursor: pointer;
        }

        .file-name:hover {
            color: #3498db;
        }

        .file-meta {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 4px;
        }

        .file-actions {
            display: flex;
            gap: 5px;
        }

        .file-actions button {
            background: #3498db;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .file-actions button:hover {
            background: #2980b9;
        }

        .file-actions button.edit {
            background: #f39c12;
        }

        .file-actions button.edit:hover {
            background: #e67e22;
        }

        .file-actions button.delete {
            background: #e74c3c;
        }

        .file-actions button.delete:hover {
            background: #c0392b;
        }

        .candidates-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        .candidates-section h2 {
            color: #2c3e50;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .progress-bar {
            background: #ecf0f1;
            height: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #3498db, #2ecc71);
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .candidates-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .candidate-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #95a5a6;
        }

        .candidate-item.pending {
            border-left-color: #95a5a6;
        }

        .candidate-item.apnea {
            border-left-color: #e74c3c;
            background: #fef5f5;
        }

        .candidate-item.skip {
            border-left-color: #bdc3c7;
            background: #f8f9fa;
            opacity: 0.6;
        }

        .candidate-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .candidate-info {
            font-size: 14px;
            color: #2c3e50;
        }

        .candidate-time {
            font-weight: bold;
            color: #3498db;
        }

        .candidate-buttons {
            display: flex;
            gap: 8px;
        }

        .candidate-buttons button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .candidate-buttons button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-play {
            background: #3498db;
            color: white;
        }

        .btn-play:hover:not(:disabled) {
            background: #2980b9;
        }

        .btn-apnea {
            background: #e74c3c;
            color: white;
        }

        .btn-apnea:hover:not(:disabled) {
            background: #c0392b;
        }

        .btn-skip {
            background: #95a5a6;
            color: white;
        }

        .btn-skip:hover:not(:disabled) {
            background: #7f8c8d;
        }

        .mode-switch {
            margin-bottom: 20px;
        }

        .mode-switch button {
            background: #34495e;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }

        .mode-switch button.active {
            background: #3498db;
        }

        .mode-switch button:hover {
            opacity: 0.9;
        }

        #manualMode, #candidateMode {
            display: none;
        }

        #manualMode.active, #candidateMode.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ ç„¡å‘¼å¸æ¤œå‡ºãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š</h1>
        <p class="subtitle">Sleep Apnea Detection Parameter Calibration Tool</p>

        <div class="instruction">
            <h3>ğŸ“ ä½¿ã„æ–¹</h3>
            <ol>
                <li>å‹•ç”»ãƒ»éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€Œè§£æé–‹å§‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                <li>ã¾ãŸã¯ã€ä»¥å‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‹ã‚‰é¸æŠ</li>
                <li>æ³¢å½¢ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰ã€ã‚¿ã‚¤ãƒ ã‚¹ã‚±ãƒ¼ãƒ«ã‚’èª¿æ•´ã—ã¦è¦‹ã‚„ã™ãã™ã‚‹</li>
                <li>æ³¢å½¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®ä½ç½®ã‹ã‚‰éŸ³å£°ãŒå†ç”Ÿã•ã‚Œã¾ã™</li>
                <li>éŸ³å£°å†ç”Ÿä½ç½®ã¯æ³¢å½¢ä¸Šã«èµ¤ã„ç¸¦ç·šã§è¡¨ç¤ºã•ã‚Œã¾ã™</li>
                <li>ç„¡å‘¼å¸ã ã¨åˆ¤æ–­ã§ãã‚‹åŒºé–“ã®<strong>é–‹å§‹æ™‚åˆ»ã¨çµ‚äº†æ™‚åˆ»</strong>ã‚’å…¥åŠ›ã—ã¦ã€Œãƒãƒ¼ã‚¯è¿½åŠ ã€</li>
                <li>è¤‡æ•°ã®ç„¡å‘¼å¸åŒºé–“ã‚’ãƒãƒ¼ã‚¯ã—ãŸã‚‰ã€Œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨ˆç®—ã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                <li>è¨ˆç®—ã•ã‚ŒãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆä»¥é™ã®è‡ªå‹•æ¤œå‡ºã«ä½¿ç”¨ï¼‰</li>
            </ol>
        </div>

        <div class="files-section">
            <h2>ğŸ“ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«</h2>
            <div class="files-list" id="filesList">
                <p style="color: #999;">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>

        <div class="upload-section">
            <input type="file" id="videoFile" accept="video/*,audio/*">
            <button onclick="loadVideo()">è§£æé–‹å§‹</button>
        </div>

        <div id="status" class="status"></div>

        <div class="mode-switch" id="modeSwitch" style="display:none;">
            <button id="btnCandidateMode" class="active" onclick="switchMode('candidate')">ğŸ¯ å€™è£œåˆ¤å®šãƒ¢ãƒ¼ãƒ‰ï¼ˆæ¨å¥¨ï¼‰</button>
            <button id="btnManualMode" onclick="switchMode('manual')">âœï¸ æ‰‹å‹•å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰</button>
        </div>

        <div id="candidateMode" class="active">
            <div class="candidates-section" id="candidatesSection">
                <h2>ğŸ¯ ç„¡å‘¼å¸å€™è£œãƒã‚¤ãƒ³ãƒˆåˆ¤å®š</h2>
                <p style="color: #7f8c8d; font-size: 13px; margin-bottom: 15px;">
                    RMSã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒå¤§ãã„ãƒã‚¤ãƒ³ãƒˆï¼ˆå‘¼å¸å†é–‹ã®å¯èƒ½æ€§ï¼‰ã‚’é †ã«åˆ¤å®šã—ã¦ãã ã•ã„
                </p>

                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%">0 / 0</div>
                </div>

                <button onclick="extractCandidates()" style="background: #27ae60; color: white; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; margin-bottom: 15px; margin-right: 10px;">
                    ğŸ“Š å€™è£œãƒã‚¤ãƒ³ãƒˆã‚’æŠ½å‡º
                </button>

                <button onclick="showJudgmentSummary()" style="background: #3498db; color: white; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; margin-bottom: 15px; margin-right: 10px;">
                    ğŸ“Š åˆ¤å®šã‚µãƒãƒªã‚’è¡¨ç¤º
                </button>

                <button onclick="calculateParametersFromCandidates()" style="background: #f39c12; color: white; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; margin-bottom: 15px;">
                    ğŸ“ˆ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨ˆç®—
                </button>

                <button onclick="calculateSAS()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 30px; border-radius: 5px; cursor: pointer; margin-bottom: 15px; margin-left: 10px; font-weight: bold;">
                    ğŸ©º SASåˆ¤å®šã‚’å®Ÿè¡Œ
                </button>

                <!-- åˆ¤å®šã‚µãƒãƒªãƒ‘ãƒãƒ« -->
                <div id="judgmentSummaryPanel" style="display: none; background: #ecf0f1; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin-top: 0; color: #2c3e50;">ğŸ“Š åˆ¤å®šã‚µãƒãƒª</h3>

                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="color: #7f8c8d; font-size: 12px;">å…¨ä½“</div>
                            <div style="font-size: 24px; font-weight: bold; color: #34495e;" id="summaryTotal">-</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="color: #7f8c8d; font-size: 12px;">âœ… ç„¡å‘¼å¸</div>
                            <div style="font-size: 24px; font-weight: bold; color: #e74c3c;" id="summaryApnea">-</div>
                            <div style="font-size: 11px; color: #95a5a6;" id="summaryApneaPct">-</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="color: #7f8c8d; font-size: 12px;">âŒ é•ã†</div>
                            <div style="font-size: 24px; font-weight: bold; color: #95a5a6;" id="summarySkip">-</div>
                            <div style="font-size: 11px; color: #95a5a6;" id="summarySkipPct">-</div>
                        </div>
                    </div>

                    <div id="apneaStatistics" style="display: none; background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-top: 0; color: #e74c3c;">ã€ç„¡å‘¼å¸ã®RMSçµ±è¨ˆã€‘</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 14px;">
                            <div><strong>å¹³å‡å€¤:</strong> <span id="statMean">-</span></div>
                            <div><strong>æ¨™æº–åå·®:</strong> <span id="statStd">-</span></div>
                            <div><strong>æœ€å°å€¤:</strong> <span id="statMin">-</span></div>
                            <div><strong>æœ€å¤§å€¤:</strong> <span id="statMax">-</span></div>
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px;">
                            <div style="font-size: 13px;"><strong>æ¨å¥¨ç¯„å›² (Î¼Â±2Ïƒ):</strong></div>
                            <div style="font-size: 16px; color: #856404; font-weight: bold;" id="statRange2Sigma">-</div>
                        </div>
                    </div>

                    <div id="additionalCandidatesControl" style="display: none;">
                        <h4 style="color: #2c3e50;">ğŸ” è¿½åŠ å€™è£œã‚’æŠ½å‡º</h4>
                        <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 10px;">
                            <label style="font-weight: bold;">ç¯„å›²:</label>
                            <select id="sigmaRange" style="padding: 8px; border: 1px solid #bdc3c7; border-radius: 5px;">
                                <option value="2.0">Î¼ Â± 2Ïƒ (95%ä¿¡é ¼åŒºé–“)</option>
                                <option value="1.0">Î¼ Â± 1Ïƒ (68%ä¿¡é ¼åŒºé–“)</option>
                            </select>
                            <label style="font-weight: bold;">æœ€å¤§ä»¶æ•°:</label>
                            <input type="number" id="maxAdditionalCandidates" value="30" min="10" max="100" style="padding: 8px; border: 1px solid #bdc3c7; border-radius: 5px; width: 80px;">
                            <button onclick="extractAdditionalCandidates()" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
                                å®Ÿè¡Œ
                            </button>
                        </div>
                        <div style="font-size: 12px; color: #7f8c8d;">
                            â€» ç„¡å‘¼å¸åˆ¤å®šã•ã‚ŒãŸRMSå€¤ã®çµ±è¨ˆã‹ã‚‰ã€ä¼¼ãŸç‰¹å¾´ã‚’æŒã¤è¿½åŠ å€™è£œã‚’æŠ½å‡ºã—ã¾ã™
                        </div>
                    </div>
                </div>

                <!-- SASåˆ¤å®šçµæœãƒ‘ãƒãƒ« -->
                <div id="sasResultPanel" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 10px; margin-bottom: 20px; color: white;">
                    <h3 style="margin-top: 0; color: white;">ğŸ©º SASåˆ¤å®šçµæœ</h3>

                    <!-- å…¨ä½“ã®AHI -->
                    <div style="background: rgba(255, 255, 255, 0.15); padding: 20px; border-radius: 8px; margin-bottom: 15px; backdrop-filter: blur(10px);">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div>
                                <div style="font-size: 13px; opacity: 0.9;">ç·éŒ²éŸ³æ™‚é–“</div>
                                <div style="font-size: 22px; font-weight: bold;" id="sasRecordingTime">-</div>
                            </div>
                            <div>
                                <div style="font-size: 13px; opacity: 0.9;">ç„¡å‘¼å¸ã‚¤ãƒ™ãƒ³ãƒˆæ•°</div>
                                <div style="font-size: 22px; font-weight: bold;" id="sasEventCount">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- AHIãƒ»é‡ç—‡åº¦ -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div style="background: rgba(255, 255, 255, 0.15); padding: 20px; border-radius: 8px; text-align: center; backdrop-filter: blur(10px);">
                            <div style="font-size: 13px; opacity: 0.9;">å…¨ä½“AHI</div>
                            <div style="font-size: 42px; font-weight: bold; margin: 5px 0;" id="sasOverallAHI">-</div>
                            <div style="font-size: 12px; opacity: 0.8;">å›/æ™‚é–“</div>
                        </div>
                        <div style="background: rgba(255, 255, 255, 0.15); padding: 20px; border-radius: 8px; text-align: center; backdrop-filter: blur(10px);">
                            <div style="font-size: 13px; opacity: 0.9;">é‡ç—‡åº¦</div>
                            <div style="font-size: 32px; font-weight: bold; margin: 5px 0;" id="sasSeverity">-</div>
                            <div style="font-size: 12px; opacity: 0.8;" id="sasSeverityNote">-</div>
                        </div>
                    </div>

                    <!-- æœ€æ‚ªæœŸé–“ -->
                    <div id="worstPeriodContainer" style="display: none; background: rgba(231, 76, 60, 0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid rgba(231, 76, 60, 0.5);">
                        <h4 style="margin: 0 0 10px 0; color: white;">âš ï¸ æœ€ã‚‚ç—‡çŠ¶ãŒå¼·ã„æ™‚é–“å¸¯</h4>
                        <div style="font-size: 14px;">
                            <div><strong>æ™‚é–“å¸¯:</strong> <span id="worstPeriodTime">-</span></div>
                            <div><strong>AHI:</strong> <span id="worstPeriodAHI">-</span> å›/æ™‚é–“</div>
                        </div>
                    </div>

                    <!-- AHIæ¨ç§»ã‚°ãƒ©ãƒ•ãƒœã‚¿ãƒ³ -->
                    <button onclick="showAHITimeline()" style="width: 100%; padding: 15px; background: rgba(255, 255, 255, 0.25); color: white; border: 2px solid rgba(255, 255, 255, 0.5); border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; backdrop-filter: blur(10px);">
                        ğŸ“Š AHIæ¨ç§»ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤º
                    </button>
                </div>

                <!-- AHIæ¨ç§»ã‚°ãƒ©ãƒ•ã‚³ãƒ³ãƒ†ãƒŠ -->
                <div id="ahiGraphContainer" style="display: none; background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #667eea;">
                    <h3 style="margin-top: 0; color: #667eea;">ğŸ“ˆ AHIæ¨ç§»ã‚°ãƒ©ãƒ•ï¼ˆã‚¹ãƒ©ã‚¤ãƒ‡ã‚£ãƒ³ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦: 5åˆ†åˆ»ã¿ï¼‰</h3>
                    <div id="ahiGraph"></div>
                    <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 13px; color: #495057;">
                        <strong>ğŸ’¡ ã‚°ãƒ©ãƒ•ã®è¦‹æ–¹:</strong><br>
                        â€¢ æ¨ªè»¸: æ™‚åˆ»ï¼ˆçª“ã®é–‹å§‹æ™‚åˆ»ï¼‰<br>
                        â€¢ ç¸¦è»¸: AHIï¼ˆ1æ™‚é–“ã‚ãŸã‚Šã®ç„¡å‘¼å¸ã‚¤ãƒ™ãƒ³ãƒˆæ•°ï¼‰<br>
                        â€¢ èµ¤ç·šï¼ˆAHI=5ï¼‰: SASè¨ºæ–­åŸºæº–<br>
                        â€¢ ã‚°ãƒ©ãƒ•ãŒèµ¤ç·šã‚’è¶…ãˆã‚‹æ™‚é–“å¸¯ã¯ã€ç¡çœ æ™‚ç„¡å‘¼å¸ç—‡å€™ç¾¤ã®ç—‡çŠ¶ãŒå‡ºã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
                    </div>
                </div>

                <div class="candidates-list" id="candidatesList"></div>
            </div>
        </div>

        <div id="manualMode">
            <div class="controls">
            <div>
                <label>ã‚¿ã‚¤ãƒ ã‚¹ã‚±ãƒ¼ãƒ« (ç§’):</label>
                <input type="range" id="timeScale" min="60" max="1800" value="300" step="60" oninput="updateTimeScale()">
                <span id="timeScaleValue">300</span>ç§’
            </div>

            <div>
                <label>é–‹å§‹æ™‚åˆ» (ç§’):</label>
                <input type="number" id="markerStart" min="0" step="0.1" placeholder="ä¾‹: 120.5">
            </div>

            <div>
                <label>çµ‚äº†æ™‚åˆ» (ç§’):</label>
                <input type="number" id="markerEnd" min="0" step="0.1" placeholder="ä¾‹: 135.0">
            </div>

            <button onclick="addMarker()">ğŸš© ãƒãƒ¼ã‚¯è¿½åŠ </button>
            <button onclick="calculateParameters()" style="background: #f39c12;">ğŸ“Š ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨ˆç®—</button>
            <button onclick="clearMarkers()" class="danger">ğŸ—‘ï¸ ãƒãƒ¼ã‚¯ã‚¯ãƒªã‚¢</button>
        </div>
        </div>

        <div class="waveform-container" id="waveformContainer" style="display:none;">
            <h2 style="margin-bottom: 10px;">éŸ³å£°æ³¢å½¢ (RMS ã‚¨ãƒãƒ«ã‚®ãƒ¼)</h2>
            <p style="color: #7f8c8d; font-size: 12px; margin-bottom: 10px;">
                æ³¢å½¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®ä½ç½®ã‹ã‚‰éŸ³å£°ãŒå†ç”Ÿã•ã‚Œã¾ã™
            </p>
            <div id="waveformPlot"></div>
        </div>

        <div class="audio-controls" id="audioControls">
            <audio id="audioPlayer" controls></audio>
        </div>

        <div class="info-panel" id="infoPanel" style="display:none;">
            <div class="info-card">
                <h3>éŒ²ç”»æ™‚é–“</h3>
                <div class="value" id="durationValue">-</div>
            </div>
            <div class="info-card">
                <h3>ãƒãƒ¼ã‚¯æ•°</h3>
                <div class="value" id="markerCount">0</div>
            </div>
            <div class="info-card">
                <h3>è¨ˆç®—ã•ã‚ŒãŸç„¡éŸ³é–¾å€¤</h3>
                <div class="value" id="silenceThreshold">-</div>
            </div>
            <div class="info-card">
                <h3>è¨ˆç®—ã•ã‚ŒãŸå‘¼å¸å†é–‹å€ç‡</h3>
                <div class="value" id="resumeMultiplier">-</div>
            </div>
        </div>

        <div class="time-settings" id="timeSettings" style="display:none; background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h3 style="margin-top: 0;">ğŸ“… æ’®å½±é–‹å§‹æ—¥æ™‚è¨­å®š</h3>
            <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
                <label style="font-weight: bold;">æ’®å½±é–‹å§‹æ—¥æ™‚:</label>
                <input type="datetime-local" id="recordingDateTime" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                <button onclick="saveRecordingDateTime()" style="padding: 8px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">ä¿å­˜</button>
                <span id="recordingDateTimeStatus" style="color: #27ae60; font-weight: bold;"></span>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <label style="font-weight: bold;">æ™‚åˆ»è¡¨ç¤º:</label>
                <button id="timeDisplayToggle" onclick="toggleTimeDisplayMode()" disabled style="padding: 8px 20px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: not-allowed; font-weight: bold;">
                    ç›¸å¯¾æ™‚é–“ â‡„ å®Ÿæ™‚åˆ»
                </button>
                <span id="currentTimeMode" style="color: #7f8c8d; font-size: 13px;">(æ’®å½±æ—¥æ™‚ã‚’è¨­å®šã—ã¦ãã ã•ã„)</span>
            </div>
        </div>

        <div class="markers-list" id="markersList" style="display:none;">
            <h3>ãƒãƒ¼ã‚¯ã—ãŸç„¡å‘¼å¸åŒºé–“</h3>
            <div id="markersContent"></div>
        </div>
    </div>

    <script>
        let currentJobId = null;
        let waveformData = null;
        let markers = [];
        let audioBlob = null;
        let playbackLineShape = null;
        let animationFrameId = null;
        let candidates = [];
        let currentMode = 'candidate';
        let recordingStartDatetime = null;  // æ’®å½±é–‹å§‹æ—¥æ™‚
        let timeDisplayMode = 'relative';    // 'relative' or 'absolute'

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å–å¾—
        window.addEventListener('DOMContentLoaded', () => {
            loadFilesList();
        });

        function switchMode(mode) {
            currentMode = mode;

            // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('btnCandidateMode').classList.toggle('active', mode === 'candidate');
            document.getElementById('btnManualMode').classList.toggle('active', mode === 'manual');

            // ãƒ¢ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('candidateMode').classList.toggle('active', mode === 'candidate');
            document.getElementById('manualMode').classList.toggle('active', mode === 'manual');
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
        }

        function hideStatus() {
            document.getElementById('status').style.display = 'none';
        }

        async function loadFilesList() {
            try {
                const response = await fetch('/calibrate/jobs?limit=20');
                if (!response.ok) throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼');

                const data = await response.json();
                displayFilesList(data.jobs);
            } catch (error) {
                console.error('ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('filesList').innerHTML = '<p style="color: #e74c3c;">ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
            }
        }

        function displayFilesList(jobs) {
            const filesListEl = document.getElementById('filesList');

            if (jobs.length === 0) {
                filesListEl.innerHTML = '<p style="color: #999;">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            filesListEl.innerHTML = jobs.map(job => {
                const fileSize = job.file_size ? (job.file_size / 1024 / 1024).toFixed(1) + ' MB' : '-';
                const createdDate = new Date(job.created_at).toLocaleString('ja-JP');
                const displayName = job.name || job.job_id;  // çœç•¥ã›ãšã«ãƒ•ãƒ«IDã‚’è¡¨ç¤º

                return `
                    <div class="file-item" id="file-${job.job_id}">
                        <div class="file-info">
                            <div class="file-name" onclick="loadExistingJob('${job.job_id}')">${displayName}</div>
                            <div class="file-meta">ä½œæˆæ—¥: ${createdDate} | ã‚µã‚¤ã‚º: ${fileSize}</div>
                        </div>
                        <div class="file-actions">
                            <button class="edit" onclick="editFileName('${job.job_id}', '${displayName}')">åå‰å¤‰æ›´</button>
                            <button onclick="loadExistingJob('${job.job_id}')">èª­ã¿è¾¼ã¿</button>
                            <button class="delete" onclick="deleteJob('${job.job_id}', '${displayName}')">å‰Šé™¤</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function editFileName(jobId, currentName) {
            const newName = prompt('æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', currentName);
            if (!newName || newName === currentName) return;

            try {
                const response = await fetch(`/calibrate/job/${jobId}/name?name=${encodeURIComponent(newName)}`, {
                    method: 'PUT'
                });

                if (!response.ok) throw new Error('åå‰å¤‰æ›´ã‚¨ãƒ©ãƒ¼');

                showStatus('ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¤‰æ›´ã—ã¾ã—ãŸ', 'success');
                loadFilesList();
            } catch (error) {
                showStatus(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function deleteJob(jobId, displayName) {
            if (!confirm(`ã€Œ${displayName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ã€éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã€è§£æçµæœãŒå…¨ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) {
                return;
            }

            showStatus('å‰Šé™¤ä¸­...', 'info');

            try {
                const response = await fetch(`/calibrate/job/${jobId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼');

                showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');

                // ç¾åœ¨èª­ã¿è¾¼ã¿ä¸­ã®ã‚¸ãƒ§ãƒ–ã ã£ãŸå ´åˆã€ç”»é¢ã‚’ã‚¯ãƒªã‚¢
                if (currentJobId === jobId) {
                    currentJobId = null;
                    waveformData = null;
                    markers = [];
                    document.getElementById('waveformContainer').style.display = 'none';
                    document.getElementById('audioControls').style.display = 'none';
                    document.getElementById('infoPanel').style.display = 'none';
                    document.getElementById('markersList').style.display = 'none';
                }

                // ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’æ›´æ–°
                loadFilesList();
            } catch (error) {
                showStatus(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function loadExistingJob(jobId) {
            showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...', 'info');

            try {
                const response = await fetch(`/calibrate/load?job_id=${jobId}`);
                if (!response.ok) throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');

                const data = await response.json();
                currentJobId = jobId;
                waveformData = data;

                // æ’®å½±é–‹å§‹æ—¥æ™‚ã¨è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã‚’å¾©å…ƒ
                recordingStartDatetime = data.recording_start_datetime || null;
                timeDisplayMode = data.time_display_mode || 'relative';

                // æ’®å½±é–‹å§‹æ—¥æ™‚UIã‚’å¾©å…ƒ
                if (recordingStartDatetime) {
                    document.getElementById('recordingDateTime').value = recordingStartDatetime;
                    const toggleBtn = document.getElementById('timeDisplayToggle');
                    toggleBtn.disabled = false;
                    toggleBtn.style.background = '#3498db';
                    toggleBtn.style.cursor = 'pointer';
                }

                updateCurrentTimeModeDisplay();

                showStatus('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†ï¼', 'success');
                displayWaveform(data);
                loadAudio(jobId);

                document.getElementById('waveformContainer').style.display = 'block';
                document.getElementById('infoPanel').style.display = 'grid';
                document.getElementById('timeSettings').style.display = 'block';
                document.getElementById('markersList').style.display = 'block';
                document.getElementById('modeSwitch').style.display = 'block';
                document.getElementById('candidatesSection').style.display = 'block';

                document.getElementById('durationValue').textContent = (data.duration_sec / 60).toFixed(1) + ' åˆ†';

            } catch (error) {
                showStatus(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function extractCandidates() {
            if (!currentJobId) {
                showStatus('å…ˆã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„', 'error');
                return;
            }

            showStatus('å€™è£œãƒã‚¤ãƒ³ãƒˆã‚’æŠ½å‡ºä¸­...', 'info');

            try {
                const response = await fetch(`/calibrate/extract-candidates?job_id=${currentJobId}&top_n=50`, {
                    method: 'POST'
                });

                if (!response.ok) throw new Error('å€™è£œæŠ½å‡ºã‚¨ãƒ©ãƒ¼');

                const data = await response.json();
                candidates = data.candidates;

                // ä¿å­˜ã•ã‚ŒãŸåˆ¤å®šçµæœã‚’èª­ã¿è¾¼ã‚€
                await loadJudgments();

                showStatus(`å€™è£œãƒã‚¤ãƒ³ãƒˆ ${candidates.length}ä»¶ã‚’æŠ½å‡ºã—ã¾ã—ãŸï¼`, 'success');
                displayCandidates();
                document.getElementById('candidatesSection').style.display = 'block';

            } catch (error) {
                showStatus(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function displayCandidates() {
            const listEl = document.getElementById('candidatesList');
            updateProgress();

            if (candidates.length === 0) {
                listEl.innerHTML = '<p style="color: #999;">å€™è£œãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            // åˆå›50ä»¶ã¨è¿½åŠ å€™è£œã‚’åˆ†ã‘ã‚‹
            const initialCandidates = candidates.filter(c => c.id < 50);
            const additionalCandidates = candidates.filter(c => c.id >= 50);

            let html = '';

            // åˆå›å€™è£œã‚»ã‚¯ã‚·ãƒ§ãƒ³
            if (initialCandidates.length > 0) {
                html += '<div style="margin-bottom: 15px;"><h4 style="color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 5px;">ğŸ“Š åˆå›å€™è£œï¼ˆä¸Šä½50ä»¶ï¼‰</h4></div>';
                html += initialCandidates.map((candidate, arrayIndex) => {
                    const index = candidates.indexOf(candidate);
                    return `
                        <div class="candidate-item ${candidate.status}" id="candidate-${index}">
                            <div class="candidate-header">
                                <div class="candidate-info">
                                    <span style="font-weight: bold; margin-right: 10px;">#${candidate.id + 1}</span>
                                    <span class="candidate-time">${formatTimeDisplay(candidate.peak_time)}</span>
                                    <span style="margin-left: 10px; color: #95a5a6; font-size: 12px;">
                                        RMS: ${candidate.peak_rms.toFixed(6)}
                                    </span>
                                </div>
                                <div class="candidate-buttons">
                                    <button class="btn-play" onclick="playCandidate(${index})">â–¶ï¸ å†ç”Ÿ</button>
                                    <button class="btn-apnea" onclick="markAsApnea(${index})">âœ… ç„¡å‘¼å¸</button>
                                    <button class="btn-skip" onclick="skipCandidate(${index})">âŒ é•ã†</button>
                                </div>
                            </div>
                            ${candidate.status === 'apnea' ? `<div style="color: #e74c3c; font-size: 12px; margin-top: 5px;">âœ“ ç„¡å‘¼å¸ã¨ã—ã¦è¨˜éŒ²ã—ã¾ã—ãŸ</div>` : ''}
                            ${candidate.status === 'skip' ? `<div style="color: #95a5a6; font-size: 12px; margin-top: 5px;">ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ</div>` : ''}
                        </div>
                    `;
                }).join('');
            }

            // è¿½åŠ å€™è£œã‚»ã‚¯ã‚·ãƒ§ãƒ³
            if (additionalCandidates.length > 0) {
                html += '<div style="margin-top: 30px; margin-bottom: 15px;"><h4 style="color: #2c3e50; border-bottom: 2px solid #27ae60; padding-bottom: 5px;">ğŸ” è¿½åŠ å€™è£œï¼ˆçµ±è¨ˆãƒ™ãƒ¼ã‚¹æŠ½å‡ºï¼‰</h4></div>';
                html += additionalCandidates.map((candidate, arrayIndex) => {
                    const index = candidates.indexOf(candidate);
                    const confidenceColor = candidate.confidence >= 0.8 ? '#27ae60' : candidate.confidence >= 0.5 ? '#f39c12' : '#e74c3c';
                    return `
                        <div class="candidate-item ${candidate.status}" id="candidate-${index}" style="border-left: 3px solid #27ae60;">
                            <div class="candidate-header">
                                <div class="candidate-info">
                                    <span style="font-weight: bold; margin-right: 10px;">#${candidate.id + 1} ğŸ†•</span>
                                    <span class="candidate-time">${formatTimeDisplay(candidate.peak_time)}</span>
                                    <span style="margin-left: 10px; color: #95a5a6; font-size: 12px;">
                                        RMS: ${candidate.peak_rms.toFixed(6)}
                                    </span>
                                    ${candidate.confidence !== undefined ? `
                                        <span style="margin-left: 10px; color: ${confidenceColor}; font-size: 11px; font-weight: bold;">
                                            ä¿¡é ¼åº¦: ${(candidate.confidence * 100).toFixed(0)}%
                                        </span>
                                    ` : ''}
                                </div>
                                <div class="candidate-buttons">
                                    <button class="btn-play" onclick="playCandidate(${index})">â–¶ï¸ å†ç”Ÿ</button>
                                    <button class="btn-apnea" onclick="markAsApnea(${index})">âœ… ç„¡å‘¼å¸</button>
                                    <button class="btn-skip" onclick="skipCandidate(${index})">âŒ é•ã†</button>
                                </div>
                            </div>
                            ${candidate.status === 'apnea' ? `<div style="color: #e74c3c; font-size: 12px; margin-top: 5px;">âœ“ ç„¡å‘¼å¸ã¨ã—ã¦è¨˜éŒ²ã—ã¾ã—ãŸ</div>` : ''}
                            ${candidate.status === 'skip' ? `<div style="color: #95a5a6; font-size: 12px; margin-top: 5px;">ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ</div>` : ''}
                        </div>
                    `;
                }).join('');
            }

            listEl.innerHTML = html;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = (seconds % 60).toFixed(1);
            return `${mins}:${secs.padStart(4, '0')}`;
        }

        function updateProgress() {
            const judged = candidates.filter(c => c.status !== 'pending').length;
            const total = candidates.length;
            const percentage = total > 0 ? (judged / total * 100) : 0;

            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = `${percentage}%`;
            progressFill.textContent = `${judged} / ${total}`;
        }

        function playCandidate(index) {
            console.log(`[DEBUG] playCandidate called - index: ${index}`);
            const startTime = performance.now();

            const candidate = candidates[index];
            console.log(`[DEBUG] candidate:`, candidate);
            console.log(`[DEBUG] apnea_start: ${candidate.apnea_start}`);

            // ãƒ”ãƒ¼ã‚¯ã®10ç§’å‰ã‹ã‚‰å†ç”Ÿ
            const beforePlay = performance.now();
            console.log(`[DEBUG] Time before playAudioAt: ${beforePlay - startTime}ms`);

            playAudioAt(candidate.apnea_start);

            const afterPlay = performance.now();
            console.log(`[DEBUG] Time after playAudioAt: ${afterPlay - beforePlay}ms`);
            console.log(`[DEBUG] Total time: ${afterPlay - startTime}ms`);

            showStatus(`å†ç”Ÿ: ${formatTime(candidate.peak_time)} ã®10ç§’å‰ã‹ã‚‰`, 'info');
        }

        async function markAsApnea(index) {
            candidates[index].status = 'apnea';
            await saveJudgment(index, 'apnea');
            displayCandidates();
            showStatus(`å€™è£œ #${index + 1} ã‚’ç„¡å‘¼å¸ã¨ã—ã¦ãƒãƒ¼ã‚¯ã—ã¾ã—ãŸ`, 'success');

            // æ¬¡ã®æœªåˆ¤å®šå€™è£œã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            scrollToNextPending(index);
        }

        async function skipCandidate(index) {
            candidates[index].status = 'skip';
            await saveJudgment(index, 'skip');
            displayCandidates();
            showStatus(`å€™è£œ #${index + 1} ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ`, 'info');

            // æ¬¡ã®æœªåˆ¤å®šå€™è£œã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            scrollToNextPending(index);
        }

        function scrollToNextPending(currentIndex) {
            const nextPending = candidates.findIndex((c, i) => i > currentIndex && c.status === 'pending');
            if (nextPending !== -1) {
                document.getElementById(`candidate-${nextPending}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        async function saveJudgment(candidateIndex, status) {
            try {
                const candidate = candidates[candidateIndex];
                const response = await fetch(`/calibrate/save-judgment?job_id=${currentJobId}&candidate_id=${candidate.id}&status=${status}`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    console.error('åˆ¤å®šä¿å­˜ã‚¨ãƒ©ãƒ¼');
                }
            } catch (error) {
                console.error('åˆ¤å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        async function loadJudgments() {
            try {
                const response = await fetch(`/calibrate/judgments?job_id=${currentJobId}`);
                if (!response.ok) return;

                const data = await response.json();
                const judgments = data.judgments;

                // å€™è£œãƒªã‚¹ãƒˆã«ä¿å­˜ã•ã‚ŒãŸåˆ¤å®šçµæœã‚’åæ˜ 
                candidates.forEach(candidate => {
                    if (judgments[candidate.id] !== undefined) {
                        candidate.status = judgments[candidate.id];
                    }
                });

                console.log(`[åˆ¤å®šèª­ã¿è¾¼ã¿] ${Object.keys(judgments).length}ä»¶ã®åˆ¤å®šã‚’å¾©å…ƒã—ã¾ã—ãŸ`);
            } catch (error) {
                console.error('åˆ¤å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        async function calculateParametersFromCandidates() {
            const apneaCandidates = candidates.filter(c => c.status === 'apnea');

            if (apneaCandidates.length === 0) {
                showStatus('ç„¡å‘¼å¸ã¨ã—ã¦ãƒãƒ¼ã‚¯ã—ãŸå€™è£œãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            // å€™è£œã‚’æ—§å½¢å¼ã®ãƒãƒ¼ã‚«ãƒ¼ã«å¤‰æ›
            const markersData = apneaCandidates.map(c => ({
                start: c.apnea_start,
                end: c.apnea_end
            }));

            showStatus('ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨ˆç®—ä¸­...', 'info');

            try {
                const response = await fetch('/calibrate/calculate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_id: currentJobId,
                        markers: markersData
                    })
                });

                if (!response.ok) throw new Error('è¨ˆç®—ã‚¨ãƒ©ãƒ¼');

                const result = await response.json();

                document.getElementById('silenceThreshold').textContent = result.silence_threshold.toFixed(6);
                document.getElementById('resumeMultiplier').textContent = result.resume_multiplier.toFixed(2) + 'x';

                showStatus(`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨ˆç®—å®Œäº†ï¼ç„¡å‘¼å¸: ${apneaCandidates.length}ä»¶`, 'success');

            } catch (error) {
                showStatus(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function loadVideo() {
            const fileInput = document.getElementById('videoFile');
            const file = fileInput.files[0];

            if (!file) {
                showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æä¸­... éŸ³å£°ã‚’æŠ½å‡ºã—ã¦ã„ã¾ã™', 'info');

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/calibrate/analyze', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`è§£æã‚¨ãƒ©ãƒ¼: ${response.statusText}`);
                }

                const data = await response.json();
                currentJobId = data.job_id;
                waveformData = data;

                showStatus('è§£æå®Œäº†ï¼æ³¢å½¢ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™', 'success');
                displayWaveform(data);
                loadAudio(data.job_id);

                document.getElementById('waveformContainer').style.display = 'block';
                document.getElementById('infoPanel').style.display = 'grid';
                document.getElementById('markersList').style.display = 'block';
                document.getElementById('modeSwitch').style.display = 'block';
                document.getElementById('candidatesSection').style.display = 'block';

                document.getElementById('durationValue').textContent = (data.duration_sec / 60).toFixed(1) + ' åˆ†';

                // ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’æ›´æ–°
                loadFilesList();

            } catch (error) {
                showStatus(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function loadAudio(jobId) {
            try {
                const response = await fetch(`/calibrate/audio?job_id=${jobId}`);
                if (!response.ok) throw new Error('éŸ³å£°å–å¾—ã‚¨ãƒ©ãƒ¼');

                audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);

                const audioPlayer = document.getElementById('audioPlayer');
                audioPlayer.src = audioUrl;

                // éŸ³å£°å†ç”Ÿã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                setupAudioSyncListeners(audioPlayer);

                document.getElementById('audioControls').style.display = 'block';

            } catch (error) {
                console.error('éŸ³å£°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function setupAudioSyncListeners(audioPlayer) {
            // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªã‚¢
            audioPlayer.removeEventListener('timeupdate', updatePlaybackLine);
            audioPlayer.removeEventListener('seeked', onAudioSeeked);

            // æ–°ã—ã„ãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            audioPlayer.addEventListener('timeupdate', updatePlaybackLine);
            audioPlayer.addEventListener('seeked', onAudioSeeked);
        }

        function updatePlaybackLine() {
            if (!waveformData) return;

            const audioPlayer = document.getElementById('audioPlayer');
            const currentTime = audioPlayer.currentTime;

            // æ³¢å½¢ä¸Šã«èµ¤ã„ç¸¦ç·šã‚’æç”»
            const currentLayout = document.getElementById('waveformPlot').layout;
            const shapes = currentLayout.shapes || [];

            // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ï¼ˆèµ¤ã„çŸ©å½¢ï¼‰ã‚’ä¿æŒ
            const markerShapes = shapes.filter(s => s.fillcolor === 'red' && s.type === 'rect');

            // å†ç”Ÿä½ç½®ã®ç¸¦ç·šã‚’è¿½åŠ 
            const playbackLine = {
                type: 'line',
                xref: 'x',
                yref: 'paper',
                x0: currentTime,
                x1: currentTime,
                y0: 0,
                y1: 1,
                line: {
                    color: 'red',
                    width: 3,
                    dash: 'solid'
                }
            };

            Plotly.relayout('waveformPlot', {
                shapes: [...markerShapes, playbackLine]
            });
        }

        function onAudioSeeked() {
            if (!waveformData) return;

            const audioPlayer = document.getElementById('audioPlayer');
            const seekTime = audioPlayer.currentTime;

            // æ³¢å½¢ã‚’è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆã‚·ãƒ¼ã‚¯ä½ç½®ãŒä¸­å¤®ã«æ¥ã‚‹ã‚ˆã†ã«ï¼‰
            const currentLayout = document.getElementById('waveformPlot').layout;
            const currentRange = currentLayout.xaxis.range;
            const rangeWidth = currentRange[1] - currentRange[0];

            // ã‚·ãƒ¼ã‚¯ä½ç½®ã‚’ä¸­å¤®ã«é…ç½®
            const newStart = Math.max(0, seekTime - rangeWidth / 2);
            const newEnd = Math.min(waveformData.duration_sec, newStart + rangeWidth);

            Plotly.relayout('waveformPlot', {
                'xaxis.range': [newStart, newEnd]
            });

            updatePlaybackLine();
        }

        function displayWaveform(data) {
            // rms_fullãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°waveformã‚’ä½¿ç”¨ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
            const waveform = data.rms_full || data.waveform;

            // æœ€å¤§å€¤ã‚’å–å¾—ã—ã¦ç¸¦è»¸ã®ç¯„å›²ã‚’æ±ºå®šï¼ˆå¤§ããªé…åˆ—ã§ã‚‚ã‚¹ã‚¿ãƒƒã‚¯ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã—ãªã„æ–¹æ³•ï¼‰
            const maxRms = waveform.y.reduce((max, val) => Math.max(max, val), -Infinity);
            // 0ã‚’ä¸­å¤®ã«é…ç½®ã™ã‚‹ãŸã‚ã€ä¸Šä¸‹å¯¾ç§°ã®ç¯„å›²ã‚’è¨­å®š
            const yMax = maxRms * 1.1;  // ä¸Šã«10%ã®ä½™ç™½
            const yRange = [-yMax, yMax];

            const trace = {
                x: waveform.t,
                y: waveform.y,
                type: 'scatter',
                mode: 'lines',
                name: 'RMS',
                line: { color: '#3498db', width: 1.5 },
                fillcolor: 'rgba(52, 152, 219, 0.2)'
            };

            // Xè»¸ãƒ©ãƒ™ãƒ«ã®è¨­å®š
            const xaxisConfig = {
                range: [0, Math.min(300, data.duration_sec)]
            };

            if (timeDisplayMode === 'absolute' && recordingStartDatetime) {
                // å®Ÿæ™‚åˆ»è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
                xaxisConfig.title = 'æ™‚åˆ»';
                // ãƒ†ã‚£ãƒƒã‚¯ã®ä½ç½®ã‚’è¨ˆç®—ï¼ˆ30ç§’é–“éš”ï¼‰
                const tickInterval = 30;
                const tickVals = [];
                const tickTexts = [];
                for (let t = 0; t <= data.duration_sec; t += tickInterval) {
                    tickVals.push(t);
                    tickTexts.push(secondsToAbsoluteTime(t).substring(6)); // "HH:MM:SS"éƒ¨åˆ†ã®ã¿
                }
                xaxisConfig.tickvals = tickVals;
                xaxisConfig.ticktext = tickTexts;
            } else {
                // ç›¸å¯¾æ™‚é–“è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
                xaxisConfig.title = 'æ™‚é–“ (ç§’)';
            }

            const layout = {
                xaxis: xaxisConfig,
                yaxis: {
                    title: 'RMS ã‚¨ãƒãƒ«ã‚®ãƒ¼',
                    range: yRange,
                    zeroline: true,
                    zerolinecolor: '#e74c3c',
                    zerolinewidth: 2,
                    fixedrange: false,
                    autorange: false
                },
                hovermode: 'x',
                shapes: [],
                margin: { l: 60, r: 30, t: 30, b: 60 }
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['lasso2d', 'select2d']
            };

            Plotly.newPlot('waveformPlot', [trace], layout, config);

            document.getElementById('waveformPlot').on('plotly_click', function(data) {
                const point = data.points[0];
                const time = point.x;
                playAudioAt(time);
            });
        }

        function playAudioAt(time) {
            console.log(`[DEBUG] playAudioAt called - time: ${time}`);
            const startTime = performance.now();

            const audioPlayer = document.getElementById('audioPlayer');
            console.log(`[DEBUG] audioPlayer:`, audioPlayer);
            console.log(`[DEBUG] audioPlayer.readyState: ${audioPlayer.readyState}`);
            console.log(`[DEBUG] audioPlayer.duration: ${audioPlayer.duration}`);
            console.log(`[DEBUG] audioPlayer.src: ${audioPlayer.src ? 'exists' : 'empty'}`);

            const beforeSeek = performance.now();
            console.log(`[DEBUG] Time before seek: ${beforeSeek - startTime}ms`);

            audioPlayer.currentTime = time;

            const afterSeek = performance.now();
            console.log(`[DEBUG] Time after seek: ${afterSeek - beforeSeek}ms`);
            console.log(`[DEBUG] New currentTime: ${audioPlayer.currentTime}`);

            const playPromise = audioPlayer.play();

            const afterPlayCall = performance.now();
            console.log(`[DEBUG] Time after play() call: ${afterPlayCall - afterSeek}ms`);

            if (playPromise !== undefined) {
                playPromise.then(() => {
                    const playStarted = performance.now();
                    console.log(`[DEBUG] Play actually started: ${playStarted - afterPlayCall}ms after play() call`);
                    console.log(`[DEBUG] Total time until play started: ${playStarted - startTime}ms`);
                }).catch(error => {
                    console.error(`[DEBUG] Play error:`, error);
                });
            }

            showStatus(`å†ç”Ÿé–‹å§‹: ${time.toFixed(1)}ç§’`, 'info');
        }

        function updateTimeScale() {
            const timeScale = parseInt(document.getElementById('timeScale').value);
            document.getElementById('timeScaleValue').textContent = timeScale;

            if (waveformData) {
                const currentLayout = document.getElementById('waveformPlot').layout;
                Plotly.relayout('waveformPlot', {
                    'xaxis.range': [0, Math.min(timeScale, waveformData.duration_sec)]
                });
            }
        }

        function addMarker() {
            const start = parseFloat(document.getElementById('markerStart').value);
            const end = parseFloat(document.getElementById('markerEnd').value);

            if (isNaN(start) || isNaN(end)) {
                showStatus('é–‹å§‹æ™‚åˆ»ã¨çµ‚äº†æ™‚åˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (start >= end) {
                showStatus('çµ‚äº†æ™‚åˆ»ã¯é–‹å§‹æ™‚åˆ»ã‚ˆã‚Šå¾Œã«ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (!waveformData) {
                showStatus('å…ˆã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æã—ã¦ãã ã•ã„', 'error');
                return;
            }

            markers.push({ start, end, duration: end - start });
            updateMarkersList();
            updateWaveformMarkers();

            document.getElementById('markerStart').value = '';
            document.getElementById('markerEnd').value = '';

            showStatus(`ãƒãƒ¼ã‚¯è¿½åŠ : ${start.toFixed(1)}ç§’ - ${end.toFixed(1)}ç§’`, 'success');
        }

        function updateMarkersList() {
            const content = document.getElementById('markersContent');
            document.getElementById('markerCount').textContent = markers.length;

            if (markers.length === 0) {
                content.innerHTML = '<p style="color: #999;">ã¾ã ãƒãƒ¼ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            content.innerHTML = markers.map((marker, index) => `
                <div class="marker-item">
                    <span>${index + 1}. ${marker.start.toFixed(1)}ç§’ - ${marker.end.toFixed(1)}ç§’ (æŒç¶š: ${marker.duration.toFixed(1)}ç§’)</span>
                    <button onclick="deleteMarker(${index})">å‰Šé™¤</button>
                </div>
            `).join('');
        }

        function deleteMarker(index) {
            markers.splice(index, 1);
            updateMarkersList();
            updateWaveformMarkers();
            showStatus('ãƒãƒ¼ã‚¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'info');
        }

        function clearMarkers() {
            if (markers.length === 0) return;

            if (confirm('ã™ã¹ã¦ã®ãƒãƒ¼ã‚¯ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                markers = [];
                updateMarkersList();
                updateWaveformMarkers();
                showStatus('ãƒãƒ¼ã‚¯ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
            }
        }

        function updateWaveformMarkers() {
            if (!waveformData) return;

            const shapes = markers.map(marker => ({
                type: 'rect',
                xref: 'x',
                yref: 'paper',
                x0: marker.start,
                x1: marker.end,
                y0: 0,
                y1: 1,
                fillcolor: 'red',
                opacity: 0.3,
                line: { width: 0 }
            }));

            Plotly.relayout('waveformPlot', { shapes });
        }

        async function calculateParameters() {
            if (markers.length === 0) {
                showStatus('å…ˆã«ç„¡å‘¼å¸åŒºé–“ã‚’ãƒãƒ¼ã‚¯ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            showStatus('ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨ˆç®—ä¸­...', 'info');

            try {
                const response = await fetch('/calibrate/calculate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_id: currentJobId,
                        markers: markers
                    })
                });

                if (!response.ok) {
                    throw new Error('è¨ˆç®—ã‚¨ãƒ©ãƒ¼');
                }

                const result = await response.json();

                document.getElementById('silenceThreshold').textContent = result.silence_threshold.toFixed(6);
                document.getElementById('resumeMultiplier').textContent = result.resume_multiplier.toFixed(2) + 'x';

                showStatus(`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨ˆç®—å®Œäº†ï¼ç„¡éŸ³é–¾å€¤: ${result.silence_threshold.toFixed(6)}, å‘¼å¸å†é–‹å€ç‡: ${result.resume_multiplier.toFixed(2)}x`, 'success');

            } catch (error) {
                showStatus(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // æ™‚åˆ»å¤‰æ›é–¢æ•°
        function secondsToAbsoluteTime(seconds) {
            if (!recordingStartDatetime) return formatTime(seconds);

            const startMs = new Date(recordingStartDatetime).getTime();
            const absoluteMs = startMs + (seconds * 1000);
            const date = new Date(absoluteMs);

            return date.toLocaleString('ja-JP', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function formatTimeDisplay(seconds) {
            if (timeDisplayMode === 'absolute' && recordingStartDatetime) {
                return secondsToAbsoluteTime(seconds);
            }
            return formatTime(seconds);
        }

        async function saveRecordingDateTime() {
            const datetimeInput = document.getElementById('recordingDateTime');
            const datetime = datetimeInput.value;

            if (!datetime) {
                showStatus('æ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            try {
                const response = await fetch(`/calibrate/job/${currentJobId}/recording-time?recording_start_datetime=${encodeURIComponent(datetime)}`, {
                    method: 'PUT'
                });

                if (!response.ok) throw new Error('ä¿å­˜ã‚¨ãƒ©ãƒ¼');

                const result = await response.json();
                recordingStartDatetime = datetime;

                // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                const toggleBtn = document.getElementById('timeDisplayToggle');
                toggleBtn.disabled = false;
                toggleBtn.style.background = '#3498db';
                toggleBtn.style.cursor = 'pointer';

                document.getElementById('recordingDateTimeStatus').textContent = 'âœ… ä¿å­˜ã—ã¾ã—ãŸ';
                setTimeout(() => {
                    document.getElementById('recordingDateTimeStatus').textContent = '';
                }, 3000);

                updateCurrentTimeModeDisplay();
                showStatus('æ’®å½±é–‹å§‹æ—¥æ™‚ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');

            } catch (error) {
                showStatus(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function toggleTimeDisplayMode() {
            if (!recordingStartDatetime) {
                showStatus('å…ˆã«æ’®å½±é–‹å§‹æ—¥æ™‚ã‚’è¨­å®šã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const newMode = timeDisplayMode === 'relative' ? 'absolute' : 'relative';

            try {
                const response = await fetch(`/calibrate/job/${currentJobId}/display-mode?mode=${newMode}`, {
                    method: 'PUT'
                });

                if (!response.ok) throw new Error('åˆ‡ã‚Šæ›¿ãˆã‚¨ãƒ©ãƒ¼');

                timeDisplayMode = newMode;
                updateCurrentTimeModeDisplay();

                // è¡¨ç¤ºã‚’æ›´æ–°
                displayCandidates();
                displayWaveform(waveformData);

                showStatus(`è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã‚’ ${newMode === 'relative' ? 'ç›¸å¯¾æ™‚é–“' : 'å®Ÿæ™‚åˆ»'} ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ`, 'success');

            } catch (error) {
                showStatus(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function updateCurrentTimeModeDisplay() {
            const modeSpan = document.getElementById('currentTimeMode');
            if (timeDisplayMode === 'relative') {
                modeSpan.textContent = 'ç¾åœ¨: ç›¸å¯¾æ™‚é–“è¡¨ç¤º';
                modeSpan.style.color = '#3498db';
            } else {
                modeSpan.textContent = 'ç¾åœ¨: å®Ÿæ™‚åˆ»è¡¨ç¤º';
                modeSpan.style.color = '#27ae60';
            }
        }

        async function showJudgmentSummary() {
            if (candidates.length === 0) {
                showStatus('å…ˆã«å€™è£œãƒã‚¤ãƒ³ãƒˆã‚’æŠ½å‡ºã—ã¦ãã ã•ã„', 'error');
                return;
            }

            try {
                const response = await fetch('/calibrate/judgment-summary', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ candidates: candidates })
                });

                if (!response.ok) throw new Error('ã‚µãƒãƒªè¨ˆç®—ã‚¨ãƒ©ãƒ¼');

                const summary = await response.json();

                // ã‚µãƒãƒªãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
                const panel = document.getElementById('judgmentSummaryPanel');
                panel.style.display = 'block';

                // å…¨ä½“çµ±è¨ˆ
                document.getElementById('summaryTotal').textContent = `${summary.total}ä»¶`;
                document.getElementById('summaryApnea').textContent = `${summary.apnea_count}ä»¶`;
                document.getElementById('summaryApneaPct').textContent = `(${summary.apnea_percentage.toFixed(1)}%)`;
                document.getElementById('summarySkip').textContent = `${summary.skip_count}ä»¶`;
                document.getElementById('summarySkipPct').textContent = `(${summary.skip_percentage.toFixed(1)}%)`;

                // ç„¡å‘¼å¸ã®çµ±è¨ˆ
                if (summary.apnea_statistics) {
                    const stats = summary.apnea_statistics;
                    document.getElementById('apneaStatistics').style.display = 'block';
                    document.getElementById('statMean').textContent = stats.mean_rms.toFixed(6);
                    document.getElementById('statStd').textContent = stats.std_rms.toFixed(6);
                    document.getElementById('statMin').textContent = stats.min_rms.toFixed(6);
                    document.getElementById('statMax').textContent = stats.max_rms.toFixed(6);
                    document.getElementById('statRange2Sigma').textContent =
                        `${stats.range_2sigma.lower.toFixed(6)} ã€œ ${stats.range_2sigma.upper.toFixed(6)}`;

                    // è¿½åŠ å€™è£œæŠ½å‡ºã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’è¡¨ç¤º
                    document.getElementById('additionalCandidatesControl').style.display = 'block';
                } else {
                    document.getElementById('apneaStatistics').style.display = 'none';
                    document.getElementById('additionalCandidatesControl').style.display = 'none';
                }

                // ãƒ‘ãƒãƒ«ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                showStatus('åˆ¤å®šã‚µãƒãƒªã‚’è¡¨ç¤ºã—ã¾ã—ãŸ', 'success');

            } catch (error) {
                showStatus(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function extractAdditionalCandidates() {
            // ç„¡å‘¼å¸åˆ¤å®šã•ã‚ŒãŸå€™è£œã®IDã‚’å–å¾—
            const apneaCandidateIds = candidates
                .filter(c => c.status === 'apnea')
                .map(c => c.id);

            if (apneaCandidateIds.length === 0) {
                showStatus('ç„¡å‘¼å¸åˆ¤å®šã•ã‚ŒãŸå€™è£œãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            const sigmaRange = parseFloat(document.getElementById('sigmaRange').value);
            const maxCandidates = parseInt(document.getElementById('maxAdditionalCandidates').value);

            showStatus('è¿½åŠ å€™è£œã‚’æŠ½å‡ºä¸­...', 'info');

            try {
                const response = await fetch('/calibrate/extract-additional-candidates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_id: currentJobId,
                        reference_candidate_ids: apneaCandidateIds,
                        sigma_range: sigmaRange,
                        max_candidates: maxCandidates
                    })
                });

                if (!response.ok) throw new Error('è¿½åŠ å€™è£œæŠ½å‡ºã‚¨ãƒ©ãƒ¼');

                const data = await response.json();

                if (data.candidate_count === 0) {
                    showStatus('æ¡ä»¶ã«åˆã†è¿½åŠ å€™è£œãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'info');
                    return;
                }

                // è¿½åŠ å€™è£œã‚’candidatesé…åˆ—ã«è¿½åŠ 
                candidates.push(...data.candidates);

                // å€™è£œãƒªã‚¹ãƒˆã‚’å†è¡¨ç¤º
                displayCandidates();

                showStatus(`âœ… ${data.candidate_count}ä»¶ã®è¿½åŠ å€™è£œã‚’æŠ½å‡ºã—ã¾ã—ãŸ (#${data.candidates[0].id + 1}ã€œ#${data.candidates[data.candidates.length - 1].id + 1})`, 'success');

                // å€™è£œãƒªã‚¹ãƒˆã®è¿½åŠ å€™è£œéƒ¨åˆ†ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                setTimeout(() => {
                    const firstAdditionalCandidate = document.getElementById(`candidate-${data.candidates[0].id}`);
                    if (firstAdditionalCandidate) {
                        firstAdditionalCandidate.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);

            } catch (error) {
                showStatus(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«AHIãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        let ahiData = null;

        async function calculateSAS() {
            if (!currentJobId) {
                showStatus('å…ˆã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (candidates.length === 0) {
                showStatus('å…ˆã«å€™è£œãƒã‚¤ãƒ³ãƒˆã‚’æŠ½å‡ºã—ã¦ãã ã•ã„', 'error');
                return;
            }

            // ç„¡å‘¼å¸åˆ¤å®šã•ã‚ŒãŸå€™è£œã®ã¿æŠ½å‡º
            const apneaEvents = candidates.filter(c => c.status === 'apnea');

            if (apneaEvents.length === 0) {
                showStatus('ç„¡å‘¼å¸åˆ¤å®šã•ã‚ŒãŸå€™è£œãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«åˆ¤å®šã‚’è¡Œã£ã¦ãã ã•ã„', 'error');
                return;
            }

            try {
                showStatus('AHIã‚’è¨ˆç®—ä¸­...', 'info');

                const response = await fetch('/calibrate/calculate-ahi', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_id: currentJobId,
                        apnea_events: apneaEvents
                    })
                });

                if (!response.ok) throw new Error('AHIè¨ˆç®—ã‚¨ãƒ©ãƒ¼');

                ahiData = await response.json();

                // SASåˆ¤å®šçµæœãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
                displaySASResult(ahiData);

                showStatus(`âœ… SASåˆ¤å®šãŒå®Œäº†ã—ã¾ã—ãŸ`, 'success');

            } catch (error) {
                showStatus(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function displaySASResult(data) {
            const panel = document.getElementById('sasResultPanel');
            panel.style.display = 'block';

            // ç·éŒ²éŸ³æ™‚é–“
            const hours = Math.floor(data.total_duration / 3600);
            const minutes = Math.floor((data.total_duration % 3600) / 60);
            const seconds = Math.floor(data.total_duration % 60);
            document.getElementById('sasRecordingTime').textContent = `${hours}æ™‚é–“${minutes}åˆ†${seconds}ç§’`;

            // ç„¡å‘¼å¸ã‚¤ãƒ™ãƒ³ãƒˆæ•°
            document.getElementById('sasEventCount').textContent = `${data.total_events}å›`;

            // å…¨ä½“AHI
            document.getElementById('sasOverallAHI').textContent = data.overall_ahi.toFixed(1);

            // é‡ç—‡åº¦è¡¨ç¤ºï¼ˆè‰²ä»˜ãï¼‰
            const severityElement = document.getElementById('sasSeverity');
            const severityNoteElement = document.getElementById('sasSeverityNote');

            const severityColors = {
                0: { bg: '#2ecc71', text: 'æ­£å¸¸', note: 'AHI < 5' },
                1: { bg: '#f39c12', text: 'è»½åº¦', note: '5 â‰¤ AHI < 15' },
                2: { bg: '#e67e22', text: 'ä¸­ç­‰åº¦', note: '15 â‰¤ AHI < 30' },
                3: { bg: '#e74c3c', text: 'é‡åº¦', note: 'AHI â‰¥ 30' }
            };

            const severityInfo = severityColors[data.severity_level];
            severityElement.textContent = severityInfo.text;
            severityNoteElement.textContent = severityInfo.note;
            severityElement.parentElement.style.background = `rgba(255, 255, 255, 0.25)`;
            severityElement.parentElement.style.border = `3px solid ${severityInfo.bg}`;

            // æœ€æ‚ªæœŸé–“
            const worstPeriodContainer = document.getElementById('worstPeriodContainer');
            if (data.worst_period) {
                worstPeriodContainer.style.display = 'block';
                document.getElementById('worstPeriodTime').textContent = formatTimeDisplay(data.worst_period.start_time);
                document.getElementById('worstPeriodAHI').textContent = data.worst_period.ahi.toFixed(1);
            } else {
                worstPeriodContainer.style.display = 'none';
            }

            // ãƒ‘ãƒãƒ«ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            setTimeout(() => {
                panel.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        function showAHITimeline() {
            if (!ahiData || !ahiData.timeline || ahiData.timeline.length === 0) {
                showStatus('AHIæ¨ç§»ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            const container = document.getElementById('ahiGraphContainer');
            container.style.display = 'block';

            // æ™‚åˆ»ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
            const times = ahiData.timeline.map(t => formatTimeDisplay(t.time));
            const ahiValues = ahiData.timeline.map(t => t.ahi);

            // SASè¨ºæ–­åŸºæº–ç·šï¼ˆAHI = 5ï¼‰
            const thresholdLine = new Array(times.length).fill(5);

            // Plotlyã§ã‚°ãƒ©ãƒ•æç”»
            const trace1 = {
                x: times,
                y: ahiValues,
                mode: 'lines+markers',
                name: 'AHI',
                line: { color: '#667eea', width: 2 },
                marker: { size: 5 }
            };

            const trace2 = {
                x: times,
                y: thresholdLine,
                mode: 'lines',
                name: 'SASè¨ºæ–­åŸºæº– (AHI=5)',
                line: { color: '#e74c3c', width: 2, dash: 'dash' }
            };

            const layout = {
                xaxis: {
                    title: 'æ™‚åˆ»',
                    tickangle: -45
                },
                yaxis: {
                    title: 'AHI (å›/æ™‚é–“)',
                    rangemode: 'tozero'
                },
                hovermode: 'closest',
                showlegend: true,
                legend: {
                    x: 0.01,
                    y: 0.99,
                    bgcolor: 'rgba(255, 255, 255, 0.8)',
                    bordercolor: '#bdc3c7',
                    borderwidth: 1
                },
                margin: { l: 60, r: 30, t: 30, b: 100 }
            };

            Plotly.newPlot('ahiGraph', [trace1, trace2], layout, { responsive: true });

            // ã‚°ãƒ©ãƒ•ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            setTimeout(() => {
                container.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
    </script>
</body>
</html>
